<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Bus Tracking System</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 2rem;
        }
        
        .logo h1 {
            font-size: 1.5rem;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .gps-status {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 20px;
        }
        
        .gps-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
        }
        
        .gps-active {
            background: #2ecc71;
        }
        
        .gps-searching {
            background: #f39c12;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #d35400;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding: 1rem;
            gap: 20px;
        }
        
        .sidebar {
            width: 320px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 1.2rem;
            color: #3498db;
        }
        
        .stat-card p {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .search-box {
            display: flex;
            gap: 5px;
        }
        
        .search-box input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .bus-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .bus-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .bus-item:hover {
            background: #e8f4fc;
        }
        
        .bus-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .bus-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-active {
            background: #e6f7ee;
            color: #27ae60;
        }
        
        .status-delayed {
            background: #fef5e7;
            color: #f39c12;
        }
        
        .status-inactive {
            background: #fae5e5;
            color: #e74c3c;
        }
        
        .map-container {
            flex: 1;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 20px;
        }
        
        .login-buttons {
            display: flex;
            gap: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .bus-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 1rem 0;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .bus-option {
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .bus-option:hover {
            background: #e8f4fc;
        }
        
        .bus-option.selected {
            background: #3498db;
            color: white;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 1.5rem;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1001;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .emergency-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            max-width: 300px;
        }
        
        .user-marker {
            color: #3498db;
            font-size: 24px;
            text-align: center;
        }
        
        .bus-marker {
            color: #2c3e50;
            font-size: 24px;
            text-align: center;
        }
        
        .bus-marker.active {
            color: #2ecc71;
        }
        
        .bus-marker.delayed {
            color: #f39c12;
        }
        
        .bus-marker.inactive {
            color: #e74c3c;
        }
        
        .tracked-bus-marker {
            color: #9b59b6;
            font-size: 24px;
            text-align: center;
        }
        
        .location-permission {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
        
        footer {
            text-align: center;
            padding: 1rem;
            background: #2c3e50;
            color: white;
            margin-top: auto;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .map-container {
                height: 400px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-bus"></i>
                    <h1>College Bus Tracking System</h1>
                </div>
                <div class="header-controls">
                    <div class="gps-status">
                        <div class="gps-indicator" id="gps-indicator"></div>
                        <span id="gps-text">GPS Status</span>
                    </div>
                    <div id="login-buttons" class="login-buttons">
                        <button class="btn btn-primary" id="driver-login-btn">Driver Login</button>
                        <button class="btn btn-success" id="student-login-btn">Student Login</button>
                    </div>
                    <div id="user-info" class="user-info" style="display: none;">
                        <span id="username"></span>
                        <button class="btn btn-danger" id="logout-btn">Logout</button>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="main-content">
            <div class="sidebar">
                <h2>Bus Status</h2>
                
                <div class="stats">
                    <div class="stat-card">
                        <h3 id="total-buses">0</h3>
                        <p>Total Buses</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="active-buses">0</h3>
                        <p>Active Buses</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="on-time-buses">0</h3>
                        <p>On Time</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="delayed-buses">0</h3>
                        <p>Delayed</p>
                    </div>
                </div>
                
                <div class="search-box">
                    <input type="text" id="bus-search" placeholder="Search buses...">
                    <button class="btn btn-primary"><i class="fas fa-search"></i></button>
                </div>
                
                <div class="bus-list" id="bus-list">
                    <!-- Bus items will be dynamically added here -->
                </div>
                
                <div id="location-permission" class="location-permission">
                    <p>Location access is required for full functionality.</p>
                    <button class="btn btn-primary" id="enable-location">Enable Location</button>
                </div>
                
                <div id="driver-controls" style="display: none;">
                    <h3>Driver Controls</h3>
                    <div class="controls">
                        <button class="btn btn-success" id="start-tracking">Start Tracking</button>
                        <button class="btn btn-danger" id="stop-tracking">Stop Tracking</button>
                    </div>
                </div>
                
                <div id="student-controls" style="display: none;">
                    <h3>Student Controls</h3>
                    <div class="controls">
                        <button class="btn btn-primary" id="track-bus">Track Bus</button>
                        <button class="btn btn-warning" id="emergency-alert">Emergency Alert</button>
                    </div>
                </div>
                
                <div class="last-update">
                    <p>Last update: <span id="last-update">--:--:--</span></p>
                </div>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
        
        <footer>
            <p>College Bus Tracking System &copy; 2023</p>
        </footer>
    </div>
    
    <!-- Driver Login Modal -->
    <div class="modal" id="driver-login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Driver Login</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="driver-id">Driver ID</label>
                <input type="text" id="driver-id" placeholder="Enter your driver ID">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password">
            </div>
            <div class="bus-options">
                <div class="bus-option" data-bus-id="bus-a1">Bus A1</div>
                <div class="bus-option" data-bus-id="bus-a2">Bus A2</div>
                <div class="bus-option" data-bus-id="bus-b1">Bus B1</div>
                <div class="bus-option" data-bus-id="bus-b2">Bus B2</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-danger" id="cancel-driver-login">Cancel</button>
                <button class="btn btn-success" id="confirm-driver-login">Login</button>
            </div>
        </div>
    </div>
    
    <!-- Student Login Modal -->
    <div class="modal" id="student-login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Student Login</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="student-id">Student ID</label>
                <input type="text" id="student-id" placeholder="Enter your student ID">
            </div>
            <div class="form-group">
                <label for="student-password">Password</label>
                <input type="password" id="student-password" placeholder="Enter your password">
            </div>
            <div class="bus-options">
                <div class="bus-option" data-bus-id="bus-a1">Bus A1</div>
                <div class="bus-option" data-bus-id="bus-a2">Bus A2</div>
                <div class="bus-option" data-bus-id="bus-b1">Bus B1</div>
                <div class="bus-option" data-bus-id="bus-b2">Bus B2</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-danger" id="cancel-student-login">Cancel</button>
                <button class="btn btn-success" id="confirm-student-login">Login</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
    // ==================== Firebase Config ====================
    const firebaseConfig = {
        apiKey: "AIzaSyBKBFZ26mQOYBs_P8V-yfWZN0yZW0aE1mQ",
        authDomain: "college-bus-tracking-sys-a565c.firebaseapp.com",
        projectId: "college-bus-tracking-sys-a565c",
        storageBucket: "college-bus-tracking-sys-a565c.appspot.com",
        messagingSenderId: "67601661951",
        appId: "1:67601661951:web:4b90d4a700c49038d931ca",
        measurementId: "G-27CHYQZFEZ"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ==================== Global Variables ====================
    let map;
    let markers = {};
    let userMarker = null;
    let selectedBusId = null;
    let gpsWatchId = null;
    let accuracyCircle = null;
    let isLoggedIn = false;
    let currentUser = null;
    let userRole = null;
    let trackedBusMarker = null;
    let busData = {};

    // ==================== Initialize App ====================
    function init() {
        // Initialize Map
        map = L.map("map").setView([12.9716, 77.5946], 14);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '© OpenStreetMap contributors',
        }).addTo(map);

        checkGPSAvailability();
        setupEventListeners();
        loadBusData();
        setupEmergencyAlertsListener();

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                pos => {
                    const { latitude, longitude } = pos.coords;
                    map.setView([latitude, longitude], 14);
                },
                err => {
                    console.warn("Could not get user location:", err.message);
                }
            );
        }
    }

    // ==================== Event Listeners ====================
    function setupEventListeners() {
        const driverLoginBtn = document.getElementById('driver-login-btn');
        const studentLoginBtn = document.getElementById('student-login-btn');
        const closeModalButtons = document.querySelectorAll('.close-modal');
        const cancelDriverLogin = document.getElementById('cancel-driver-login');
        const cancelStudentLogin = document.getElementById('cancel-student-login');
        const confirmDriverLogin = document.getElementById('confirm-driver-login');
        const confirmStudentLogin = document.getElementById('confirm-student-login');
        const logoutBtn = document.getElementById('logout-btn');
        const enableLocation = document.getElementById('enable-location');
        const zoomIn = document.getElementById('zoom-in');
        const zoomOut = document.getElementById('zoom-out');
        const locateMe = document.getElementById('locate-me');
        const startTracking = document.getElementById('start-tracking');
        const stopTracking = document.getElementById('stop-tracking');
        const trackBus = document.getElementById('track-bus');
        const busSearch = document.getElementById('bus-search');
        const searchButton = document.querySelector('.search-box button');
        const busOptions = document.querySelectorAll('.bus-option');
        const emergencyAlertBtn = document.getElementById('emergency-alert');

        if (driverLoginBtn) driverLoginBtn.addEventListener('click', () => {
            document.getElementById('driver-login-modal').style.display = 'flex';
        });

        if (studentLoginBtn) studentLoginBtn.addEventListener('click', () => {
            document.getElementById('student-login-modal').style.display = 'flex';
        });

        if (closeModalButtons.length > 0) {
            closeModalButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
                });
            });
        }

        if (cancelDriverLogin) cancelDriverLogin.addEventListener('click', () => {
            document.getElementById('driver-login-modal').style.display = 'none';
        });
        
        if (cancelStudentLogin) cancelStudentLogin.addEventListener('click', () => {
            document.getElementById('student-login-modal').style.display = 'none';
        });

        if (confirmDriverLogin) confirmDriverLogin.addEventListener('click', handleDriverLogin);
        if (confirmStudentLogin) confirmStudentLogin.addEventListener('click', handleStudentLogin);
        if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
        if (enableLocation) enableLocation.addEventListener('click', enableLocationHandler);
        if (startTracking) startTracking.addEventListener('click', startDriverTracking);
        if (stopTracking) stopTracking.addEventListener('click', stopDriverTracking);
        if (trackBus) trackBus.addEventListener('click', trackBusHandler);
        if (busSearch) busSearch.addEventListener('input', filterBusList);
        if (searchButton) searchButton.addEventListener('click', filterBusList);
        if (emergencyAlertBtn) emergencyAlertBtn.addEventListener('click', () => {
            sendEmergencyAlert(selectedBusId, 'General Emergency');
        });

        if (busOptions.length > 0) {
            busOptions.forEach(option => {
                option.addEventListener('click', function () {
                    document.querySelectorAll('.bus-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }
    }

    // ==================== Firebase Bus Functions ====================
    async function sendLocationToServer(busId, latitude, longitude) {
        try {
            const busRef = db.collection("buses").doc(busId);
            await busRef.set({
                lat: latitude,
                lng: longitude,
                lastUpdate: new Date().toISOString(),
                status: "active",
                // Preserve existing data
                ...busData[busId]
            }, { merge: true });
            
            // Also save to history
            const historyRef = db.collection("busHistory").doc();
            await historyRef.set({
                busId: busId,
                lat: latitude,
                lng: longitude,
                timestamp: new Date().toISOString()
            });
            
            console.log("Location updated in Firebase for bus", busId);
        } catch (error) {
            console.error("Error sending location to Firebase:", error);
            throw error;
        }
    }

    function loadBusData() {
        db.collection("buses").onSnapshot((snapshot) => {
            busData = {};
            snapshot.forEach(doc => {
                // Include document ID in the data
                busData[doc.id] = { id: doc.id, ...doc.data() };
            });
            updateBusList(busData);

            for (const busId in busData) {
                const bus = busData[busId];
                if (bus.lat && bus.lng) {
                    updateBusMarker(busId, bus.lat, bus.lng, bus.status || "inactive");
                }
            }

            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            updateTrackButtonState();
        }, error => {
            console.error("Error loading bus data from Firebase:", error);
            showToast("Using demo data - Firebase not reachable", 2000);
            
            // Demo data for testing
            busData = {
                "bus-a1": { lat: 12.9716, lng: 77.5946, status: "active", name: "Bus A1" },
                "bus-a2": { lat: 12.9686, lng: 77.5876, status: "delayed", name: "Bus A2" },
                "bus-b1": { lat: 12.9746, lng: 77.6016, status: "active", name: "Bus B1" },
                "bus-b2": { lat: 12.9698, lng: 77.6021, status: "active", name: "Bus B2" }
            };
            updateBusList(busData);
            
            for (const busId in busData) {
                const bus = busData[busId];
                updateBusMarker(busId, bus.lat, bus.lng, bus.status || "inactive");
            }
            updateTrackButtonState();
        });
    }

    // ==================== Login/Logout ====================
    async function handleDriverLogin() {
        const driverId = document.getElementById('driver-id').value.trim();
        const password = document.getElementById('password').value;
        const selectedBusOption = document.querySelector('#driver-login-modal .bus-option.selected');

        if (!driverId || !password || !selectedBusOption) {
            showToast("Please fill all fields and select a bus");
            return;
        }

        const busId = selectedBusOption.getAttribute('data-bus-id');

        try {
            const driverRef = db.collection("drivers").doc(driverId);
            const driverSnap = await driverRef.get();
            
            if (!driverSnap.exists) {
                showToast("Driver ID not found");
                return;
            }

            const driverData = driverSnap.data();
            
            if (driverData.password !== password) {
                showToast("Incorrect password");
                return;
            }

            if (driverData.busId !== busId) {
                showToast("Driver not assigned to this bus");
                return;
            }

            if (driverData.active === false) {
                showToast("Your account is deactivated. Please contact administrator.");
                return;
            }

            isLoggedIn = true;
            currentUser = driverId;
            userRole = 'driver';
            selectedBusId = busId;

            await db.collection("buses").doc(busId).set({ 
                driver: driverId, 
                driverName: driverData.name,
                status: "active",
                lastUpdate: new Date().toISOString()
            }, { merge: true });

            updateUIAfterLogin(driverData.name, 'driver');
            showToast(`Welcome, ${driverData.name}`);

        } catch (error) {
            console.error("Login error:", error);
            showToast("Error logging in. Please try again.");
        }
    }

    async function handleStudentLogin() {
        const studentId = document.getElementById('student-id').value.trim();
        const password = document.getElementById('student-password').value;
        const selectedBusOption = document.querySelector('#student-login-modal .bus-option.selected');

        if (!studentId || !password || !selectedBusOption) {
            showToast("Please fill all fields and select a bus");
            return;
        }

        const busId = selectedBusOption.getAttribute('data-bus-id');

        try {
            const studentRef = db.collection("students").doc(studentId);
            const studentSnap = await studentRef.get();
            if (!studentSnap.exists) {
                showToast("Student ID not found");
                return;
            }

            const studentData = studentSnap.data();
            if (studentData.password !== password) {
                showToast("Incorrect password");
                return;
            }

            isLoggedIn = true;
            currentUser = studentId;
            userRole = 'student';
            selectedBusId = busId;

            if (busData[selectedBusId]) {
                showToast(`Welcome, ${studentData.name}. Bus found.`);
            } else {
                showToast(`Welcome, ${studentData.name}. Loading bus data...`);
            }

            updateUIAfterLogin(studentData.name, 'student');
            updateTrackButtonState();

        } catch (error) {
            console.error("Login error:", error);
            showToast("Error logging in. Please try again.");
        }
    }

    function updateUIAfterLogin(username, role) {
        document.getElementById('user-info').style.display = 'flex';
        document.getElementById('login-buttons').style.display = 'none';
        document.getElementById('username').textContent = username;
        
        if (role === 'driver') {
            document.getElementById('driver-controls').style.display = 'flex';
            document.getElementById('student-controls').style.display = 'none';
        } else {
            document.getElementById('driver-controls').style.display = 'none';
            document.getElementById('student-controls').style.display = 'flex';
        }
        
        document.getElementById(`${role}-login-modal`).style.display = 'none';
        document.getElementById(`${role}-id`).value = '';
        document.getElementById(`${role}-password`).value = '';
        document.querySelectorAll('.bus-option').forEach(opt => opt.classList.remove('selected'));
    }

    function handleLogout() {
        if (userRole === 'driver') {
            db.collection("buses").doc(selectedBusId).set({ 
                driver: null, 
                driverName: null,
                status: "inactive" 
            }, { merge: true });
            
            if (gpsWatchId !== null) {
                navigator.geolocation.clearWatch(gpsWatchId);
                gpsWatchId = null;
            }
        }
        
        isLoggedIn = false;
        currentUser = null;
        userRole = null;
        selectedBusId = null;
        
        document.getElementById('user-info').style.display = 'none';
        document.getElementById('login-buttons').style.display = 'flex';
        document.getElementById('driver-controls').style.display = 'none';
        document.getElementById('student-controls').style.display = 'none';
        
        if (trackedBusMarker) {
            map.removeLayer(trackedBusMarker);
            trackedBusMarker = null;
        }
        
        updateTrackButtonState();
        
        showToast("Logged out successfully");
    }

    // ==================== GPS & Location Functions ====================
    function checkGPSAvailability() {
        if (!navigator.geolocation) {
            document.getElementById('gps-text').textContent = "GPS Not Supported";
            document.getElementById('gps-indicator').className = "gps-indicator gps-inactive";
            document.getElementById('location-permission').style.display = 'block';
            return false;
        }
        return true;
    }

    function enableLocationHandler() {
        if (!navigator.geolocation) {
            showToast("Geolocation is not supported by your browser");
            return;
        }
        
        document.getElementById('location-permission').style.display = 'none';
        centerMapOnUser();
    }

    function centerMapOnUser() {
        if (!navigator.geolocation) {
            showToast("Geolocation is not supported by your browser");
            return;
        }
        
        updateGPSStatus("searching");
        
        navigator.geolocation.getCurrentPosition(
            position => {
                const { latitude, longitude, accuracy } = position.coords;
                
                if (userMarker) {
                    map.removeLayer(userMarker);
                    if (accuracyCircle) map.removeLayer(accuracyCircle);
                }
                
                userMarker = L.marker([latitude, longitude], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<i class="fas fa-user"></i>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(map).bindPopup("Your Location").openPopup();
                
                accuracyCircle = L.circle([latitude, longitude], {
                    radius: accuracy,
                    color: '#3498db',
                    fillColor: '#3498db',
                    fillOpacity: 0.2,
                    weight: 1
                }).addTo(map);
                
                map.setView([latitude, longitude], 16);
                
                updateGPSStatus("active");
            },
            error => {
                console.error("Error getting location:", error);
                updateGPSStatus("inactive");
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        showToast("Location access denied");
                        document.getElementById('location-permission').style.display = 'block';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        showToast("Location information unavailable");
                        break;
                    case error.TIMEOUT:
                        showToast("Location request timed out");
                        break;
                    default:
                        showToast("Unknown error getting location");
                }
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }

    function updateGPSStatus(status) {
        const indicator = document.getElementById('gps-indicator');
        const text = document.getElementById('gps-text');
        
        indicator.className = "gps-indicator";
        
        switch(status) {
            case "active":
                indicator.classList.add("gps-active");
                text.textContent = "GPS Active";
                break;
            case "inactive":
                indicator.classList.add("gps-inactive");
                text.textContent = "GPS Inactive";
                break;
            case "searching":
                indicator.classList.add("gps-searching");
                text.textContent = "Searching...";
                break;
        }
    }

    // ==================== Driver Functions ====================
    function startDriverTracking() {
        if (!selectedBusId) {
            showToast("No bus selected");
            return;
        }
        
        if (!navigator.geolocation) {
            showToast("Geolocation is not supported by your browser");
            return;
        }
        
        updateGPSStatus("searching");
        
        if (gpsWatchId !== null) {
            navigator.geolocation.clearWatch(gpsWatchId);
        }
        
        gpsWatchId = navigator.geolocation.watchPosition(
            async (position) => {
                const { latitude, longitude, accuracy } = position.coords;
                
                try {
                    await sendLocationToServer(selectedBusId, latitude, longitude);
                    updateGPSStatus("active");
                    
                    if (accuracyCircle) {
                        map.removeLayer(accuracyCircle);
                    }
                    
                    accuracyCircle = L.circle([latitude, longitude], {
                        radius: accuracy,
                        color: '#3498db',
                        fillColor: '#3498db',
                        fillOpacity: 0.2,
                        weight: 1
                    }).addTo(map);
                    
                } catch (error) {
                    console.error("Error updating location:", error);
                    showToast("Error updating location");
                }
            },
            (error) => {
                console.error("Error watching position:", error);
                updateGPSStatus("inactive");
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        showToast("Location access denied. Please enable location permissions.");
                        break;
                    case error.POSITION_UNAVAILABLE:
                        showToast("Location information unavailable");
                        break;
                    case error.TIMEOUT:
                        showToast("Location request timed out");
                        break;
                    default:
                        showToast("Error getting location");
                }
            },
            {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            }
        );
        
        showToast("Started tracking your bus");
    }

    function stopDriverTracking() {
        if (gpsWatchId !== null) {
            navigator.geolocation.clearWatch(gpsWatchId);
            gpsWatchId = null;
        }
        
        db.collection("buses").doc(selectedBusId).set({ 
            status: "inactive" 
        }, { merge: true });
        
        updateGPSStatus("inactive");
        showToast("Stopped tracking your bus");
    }

    // ==================== Student Functions ====================
    function trackBusHandler() {
        if (!selectedBusId) {
            showToast("Please select a bus first.");
            return;
        }
        
        const bus = busData[selectedBusId];
        if (!bus) {
            showToast("Data for the selected bus is still loading. Please wait a moment.");
            return;
        }
        
        if (bus.lat === undefined || bus.lng === undefined) {
            showToast("The location for " + (bus.name || selectedBusId) + " is not available yet.");
            return;
        }
        
        if (bus.status === "inactive") {
            showToast("Warning: " + (bus.name || selectedBusId) + " is currently inactive.");
        }
        
        map.setView([bus.lat, bus.lng], 15);
        
        if (trackedBusMarker) {
            map.removeLayer(trackedBusMarker);
        }
        
        trackedBusMarker = L.marker([bus.lat, bus.lng], {
            icon: L.divIcon({
                className: 'tracked-bus-marker',
                html: '<i class="fas fa-bus"></i>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            })
        }).addTo(map).bindPopup(`Tracked Bus: ${bus.name || selectedBusId}`).openPopup();
        
        showToast(`Now tracking ${bus.name || selectedBusId}`);
    }

    function updateTrackButtonState() {
        const trackBusBtn = document.getElementById('track-bus');
        if (!trackBusBtn) return;

        if (selectedBusId && busData[selectedBusId] && busData[selectedBusId].lat) {
            trackBusBtn.disabled = false;
            trackBusBtn.title = "Track your selected bus";
        } else {
            trackBusBtn.disabled = true;
            trackBusBtn.title = "Select a bus and wait for location data...";
        }
    }

    // ==================== Bus List Functions ====================
    function updateBusList(buses) {
        const busList = document.getElementById('bus-list');
        busList.innerHTML = '';
        
        let totalBuses = 0;
        let onTimeCount = 0;
        let delayedCount = 0;
        let activeBuses = 0;

        for (const busId in buses) {
            const bus = buses[busId];
            totalBuses++;
            
            if (bus.status === "active") activeBuses++;
            if (bus.status === "delayed") delayedCount++;
            if (bus.status === "active" || !bus.status) onTimeCount++;
            
            const busItem = document.createElement('div');
            busItem.className = 'bus-item';
            busItem.setAttribute('data-bus-id', busId);
            
            const statusClass = bus.status === "active" ? "status-active" : 
                               bus.status === "delayed" ? "status-delayed" : "status-inactive";
            
            busItem.innerHTML = `
                <div class="bus-info">
                    <span class="bus-name">${bus.name || busId}</span>
                    <span class="bus-status ${statusClass}">${bus.status || "inactive"}</span>
                </div>
                <div class="bus-driver">${bus.driverName || "No driver"}</div>
            `;
            
            busList.appendChild(busItem);
        }

        document.getElementById('total-buses').textContent = totalBuses;
        document.getElementById('active-buses').textContent = activeBuses;
        document.getElementById('delayed-buses').textContent = delayedCount;
        document.getElementById('on-time-buses').textContent = onTimeCount;
    }

    function filterBusList() {
        const searchTerm = document.getElementById('bus-search').value.toLowerCase();
        const busItems = document.querySelectorAll('.bus-item');
        
        busItems.forEach(item => {
            const busId = item.getAttribute('data-bus-id');
            const busName = item.querySelector('.bus-name').textContent.toLowerCase();
            const shouldShow = busId.includes(searchTerm) || busName.includes(searchTerm);
            item.style.display = shouldShow ? 'flex' : 'none';
        });
    }

    // ==================== Map & Marker Functions ====================
    function updateBusMarker(busId, lat, lng, status) {
        if (markers[busId]) {
            map.removeLayer(markers[busId]);
        }
        
        const busIcon = L.divIcon({
            className: `bus-marker ${status}`,
            html: `<i class="fas fa-bus"></i>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });
        
        markers[busId] = L.marker([lat, lng], { icon: busIcon })
            .addTo(map)
            .bindPopup(`
                <strong>${busData[busId]?.name || busId}</strong><br>
                Status: ${status}<br>
                Driver: ${busData[busId]?.driverName || "Unknown"}<br>
                Last update: ${new Date().toLocaleTimeString()}
            `);
    }

    // ==================== Emergency Functions ====================
    async function sendEmergencyAlert(busId, alertType) {
        if (!busId) {
            showToast("No bus selected");
            return;
        }
        
        try {
            const alertRef = db.collection("emergencyAlerts").doc();
            await alertRef.set({
                busId: busId,
                alertType: alertType,
                timestamp: new Date().toISOString(),
                status: "active",
                location: busData[busId] ? {
                    lat: busData[busId].lat,
                    lng: busData[busId].lng
                } : null
            });
            
            showToast("Emergency alert sent!");
        } catch (error) {
            console.error("Error sending emergency alert:", error);
            showToast("Error sending alert");
        }
    }

    function setupEmergencyAlertsListener() {
        db.collection("emergencyAlerts")
            .where("status", "==", "active")
            .onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const alert = { id: change.doc.id, ...change.doc.data() };
                        showEmergencyAlert(alert);
                    }
                });
            });
    }

    function showEmergencyAlert(alert) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'emergency-alert';
        alertDiv.innerHTML = `
            <h3>🚨 Emergency Alert</h3>
            <p>Bus: ${alert.busId}</p>
            <p>Type: ${alert.alertType}</p>
            <p>Time: ${new Date(alert.timestamp).toLocaleTimeString()}</p>
            <button onclick="acknowledgeAlert('${alert.id}')">Acknowledge</button>
        `;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 30000);
    }

    function acknowledgeAlert(alertId) {
        db.collection("emergencyAlerts").doc(alertId).update({
            status: "acknowledged"
        });
        
        const alertDiv = document.querySelector('.emergency-alert');
        if (alertDiv) {
            alertDiv.remove();
        }
    }

    // ==================== Utility Functions ====================
    function showToast(message, duration = 3000) {
        const existingToast = document.getElementById('toast');
        if (existingToast) {
            existingToast.remove();
        }
        
        const toast = document.createElement('div');
        toast.id = 'toast';
        toast.className = 'toast';
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, duration);
    }

    // Get bus history for a specific bus
    async function getBusHistory(busId, limit = 10) {
        try {
            const historyRef = db.collection("busHistory")
                .where("busId", "==", busId)
                .orderBy("timestamp", "desc")
                .limit(limit);
            
            const snapshot = await historyRef.get();
            const history = [];
            
            snapshot.forEach(doc => {
                history.push(doc.data());
            });
            
            return history;
        } catch (error) {
            console.error("Error getting bus history:", error);
            return [];
        }
    }

    // ==================== Initialize App ====================
    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>