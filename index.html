<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bus Tracker with GPS</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
          display: flex;
          flex-direction: column;
          height: 100vh;
          overflow: hidden;
          background-color: #f5f7fa;
      }

      header {
          background: linear-gradient(135deg, #2c3e50, #1a2530);
          color: white;
          padding: 15px 20px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      }

      .logo {
          display: flex;
          align-items: center;
          gap: 10px;
      }

      .logo i {
          font-size: 28px;
          color: #3498db;
      }

      .header-info {
          display: flex;
          gap: 20px;
          font-size: 14px;
          background: rgba(255, 255, 255, 0.1);
          padding: 8px 15px;
          border-radius: 20px;
      }

      .auth-buttons {
          display: flex;
          gap: 10px;
      }

      .auth-btn {
          padding: 8px 16px;
          border: none;
          border-radius: 20px;
          cursor: pointer;
          font-weight: bold;
          transition: all 0.3s ease;
      }

      .btn-login {
          background-color: #3498db;
          color: white;
      }

      .btn-login:hover {
          background-color: #2980b9;
          transform: translateY(-2px);
      }

      .btn-student {
          background-color: #9b59b6;
          color: white;
      }

      .btn-student:hover {
          background-color: #8e44ad;
          transform: translateY(-2px);
      }

      .btn-logout {
          background-color: #e74c3c;
          color: white;
      }

      .btn-logout:hover {
          background-color: #c0392b;
          transform: translateY(-2px);
      }

      .user-info {
          display: flex;
          align-items: center;
          gap: 10px;
          color: white;
      }

      .user-info i {
          font-size: 20px;
      }

      .container {
          display: flex;
          flex: 1;
          overflow: hidden;
      }

      .sidebar {
          width: 350px;
          background-color: #fff;
          border-right: 1px solid #e0e0e0;
          display: flex;
          flex-direction: column;
          overflow: hidden;
          box-shadow: 2px 0 10px rgba(0,0,0,0.05);
      }

      .sidebar-header {
          padding: 20px;
          background-color: #ecf0f1;
          border-bottom: 1px solid #e0e0e0;
      }

      .search-box {
          display: flex;
          margin-bottom: 15px;
      }

      .search-box input {
          flex: 1;
          padding: 12px;
          border: 1px solid #ddd;
          border-radius: 25px 0 0 25px;
          outline: none;
          font-size: 14px;
      }

      .search-box button {
          padding: 12px 15px;
          background-color: #3498db;
          color: white;
          border: none;
          border-radius: 0 25px 25px 0;
          cursor: pointer;
          transition: background-color 0.3s;
      }

      .search-box button:hover {
          background-color: #2980b9;
      }

      .stats {
          display: flex;
          justify-content: space-between;
          background-color: white;
          padding: 15px;
          border-radius: 10px;
          box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      }

      .stat-item {
          text-align: center;
          flex: 1;
          padding: 0 5px;
      }

      .stat-value {
          font-size: 20px;
          font-weight: bold;
          color: #2c3e50;
      }

      .stat-label {
          font-size: 12px;
          color: #7f8c8d;
          margin-top: 5px;
      }

      .bus-list {
          flex: 1;
          overflow-y: auto;
          padding: 15px;
      }

      .bus-item {
          display: flex;
          align-items: center;
          padding: 15px;
          background-color: white;
          margin-bottom: 12px;
          border-radius: 10px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.06);
          cursor: pointer;
          transition: all 0.3s ease;
          border-left: 4px solid #3498db;
      }

      .bus-item:hover {
          transform: translateY(-3px);
          box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      }

      .bus-icon {
          width: 45px;
          height: 45px;
          background: linear-gradient(135deg, #3498db, #2c3e50);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          margin-right: 15px;
          font-size: 18px;
      }

      .bus-info {
          flex: 1;
      }

      .bus-info h3 {
          font-size: 16px;
          margin-bottom: 5px;
          color: #2c3e50;
      }

      .bus-info p {
          font-size: 12px;
          color: #7f8c8d;
      }

      .bus-status {
          padding: 6px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: bold;
      }

      .status-on-time {
          background-color: #e8f5e9;
          color: #2e7d32;
      }

      .status-delayed {
          background-color: #ffebee;
          color: #c62828;
      }

      .status-arriving {
          background-color: #fff8e1;
          color: #f9a825;
      }

      .status-active {
          background-color: #e8f5e9;
          color: #2e7d32;
      }

      .status-inactive {
          background-color: #f5f5f5;
          color: #757575;
      }

      .map-container {
          flex: 1;
          position: relative;
      }

      #map {
          height: 100%;
          width: 100%;
      }

      .map-controls {
          position: absolute;
          top: 20px;
          right: 20px;
          z-index: 1000;
          display: flex;
          flex-direction: column;
          gap: 12px;
      }

      .control-btn {
          width: 45px;
          height: 45px;
          border-radius: 50%;
          background-color: white;
          border: none;
          box-shadow: 0 3px 10px rgba(0,0,0,0.15);
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          color: #2c3e50;
          font-size: 18px;
          transition: all 0.3s ease;
      }

      .control-btn:hover {
          background-color: #f8f9fa;
          transform: scale(1.1);
      }

      .gps-status {
          position: absolute;
          bottom: 20px;
          left: 20px;
          z-index: 1000;
          background-color: white;
          padding: 10px 15px;
          border-radius: 25px;
          box-shadow: 0 3px 10px rgba(0,0,0,0.15);
          display: flex;
          align-items: center;
          gap: 10px;
          font-size: 14px;
      }

      .gps-indicator {
          width: 12px;
          height: 12px;
          border-radius: 50%;
      }

      .gps-active {
          background-color: #4caf50;
          box-shadow: 0 0 8px #4caf50;
      }

      .gps-inactive {
          background-color: #f44336;
      }

      .gps-searching {
          background-color: #ff9800;
          animation: pulse 1.5s infinite;
      }

      .user-marker, .tracked-bus-marker, .bus-marker {
          width: 30px;
          height: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
          font-size: 14px;
      }

      .user-marker {
          background-color: #3498db;
          color: white;
      }

      .tracked-bus-marker {
          background-color: #9b59b6;
          color: white;
      }

      .bus-marker {
          background-color: #e74c3c;
          color: white;
      }

      .bus-marker.active {
          background-color: #2ecc71;
      }

      @keyframes pulse {
          0% { opacity: 1; }
          50% { opacity: 0.5; }
          100% { opacity: 1; }
      }

      .modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.5);
          z-index: 2000;
          align-items: center;
          justify-content: center;
      }

      .modal-content {
          background-color: white;
          border-radius: 12px;
          width: 400px;
          max-width: 90%;
          box-shadow: 0 5px 20px rgba(0,0,0,0.2);
          overflow: hidden;
          animation: modalFadeIn 0.3s;
      }

      @keyframes modalFadeIn {
          from { opacity: 0; transform: translateY(-20px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .modal-header {
          padding: 20px;
          background: linear-gradient(135deg, #2c3e50, #1a2530);
          color: white;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .close-modal {
          background: none;
          border: none;
          color: white;
          font-size: 24px;
          cursor: pointer;
          transition: transform 0.2s;
      }

      .close-modal:hover {
          transform: scale(1.2);
      }

      .modal-body {
          padding: 25px;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: bold;
          color: #2c3e50;
      }

      .form-group input {
          width: 100%;
          padding: 12px;
          border: 1px solid #ddd;
          border-radius: 6px;
          outline: none;
          font-size: 16px;
          transition: border-color 0.3s;
      }

      .form-group input:focus {
          border-color: #3498db;
          box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      }

      .bus-options {
          display: flex;
          flex-direction: column;
          gap: 12px;
          margin: 20px 0;
      }

      .bus-option {
          padding: 15px;
          border: 1px solid #ddd;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .bus-option:hover {
          background-color: #f5f7fa;
          transform: translateX(5px);
      }

      .bus-option.selected {
          border-color: #3498db;
          background-color: #e3f2fd;
      }

      .modal-footer {
          padding: 20px;
          background-color: #f8f9fa;
          display: flex;
          justify-content: flex-end;
          gap: 12px;
      }

      .modal-btn {
          padding: 10px 20px;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-weight: bold;
          transition: all 0.3s ease;
      }

      .btn-cancel {
          background-color: #f8f9fa;
          color: #6c757d;
      }

      .btn-cancel:hover {
          background-color: #e9ecef;
      }

      .btn-confirm {
          background-color: #3498db;
          color: white;
      }

      .btn-confirm:hover {
          background-color: #2980b9;
          transform: translateY(-2px);
      }

      .toast {
          position: fixed;
          bottom: 25px;
          right: 25px;
          padding: 15px 25px;
          background-color: #323232;
          color: white;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          display: flex;
          align-items: center;
          gap: 12px;
          z-index: 3000;
          opacity: 0;
          transform: translateY(20px);
          transition: opacity 0.3s, transform 0.3s;
      }

      .toast.show {
          opacity: 1;
          transform: translateY(0);
      }

      .driver-controls {
          position: absolute;
          bottom: 80px;
          left: 20px;
          z-index: 1000;
          background-color: white;
          padding: 15px;
          border-radius: 10px;
          box-shadow: 0 3px 10px rgba(0,0,0,0.15);
          display: none;
          flex-direction: column;
          gap: 12px;
      }

      .student-controls {
          position: absolute;
          bottom: 80px;
          left: 20px;
          z-index: 1000;
          background-color: white;
          padding: 15px;
          border-radius: 10px;
          box-shadow: 0 3px 10px rgba(0,0,0,0.15);
          display: none;
          flex-direction: column;
          gap: 12px;
      }

      .driver-btn, .student-btn {
          padding: 10px 15px;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-weight: bold;
          transition: all 0.3s ease;
      }

      .btn-start {
          background-color: #4caf50;
          color: white;
      }

      .btn-start:hover {
          background-color: #45a049;
          transform: translateY(-2px);
      }

      .btn-stop {
          background-color: #f44336;
          color: white;
      }

      .btn-stop:hover {
          background-color: #e53935;
          transform: translateY(-2px);
      }

      .btn-track {
          background-color: #9b59b6;
          color: white;
      }

      .btn-track:hover {
          background-color: #8e44ad;
          transform: translateY(-2px);
      }

      .location-permission {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background-color: white;
          padding: 25px;
          border-radius: 12px;
          box-shadow: 0 5px 20px rgba(0,0,0,0.2);
          text-align: center;
          z-index: 1000;
          max-width: 400px;
          display: none;
      }

      .location-permission i {
          font-size: 48px;
          color: #3498db;
          margin-bottom: 15px;
      }

      .location-permission h2 {
          margin-bottom: 15px;
          color: #2c3e50;
      }

      .location-permission p {
          margin-bottom: 20px;
          color: #7f8c8d;
      }

      .permission-btn {
          padding: 12px 25px;
          background-color: #3498db;
          color: white;
          border: none;
          border-radius: 25px;
          cursor: pointer;
          font-weight: bold;
          transition: all 0.3s ease;
      }

      .permission-btn:hover {
          background-color: #2980b9;
          transform: translateY(-2px);
      }

      .emergency-alert {
          position: fixed;
          top: 20px;
          right: 20px;
          background-color: #ff5252;
          color: white;
          padding: 15px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          z-index: 4000;
          max-width: 300px;
      }

      .emergency-alert h3 {
          margin-bottom: 10px;
      }

      .emergency-alert button {
          margin-top: 10px;
          padding: 8px 16px;
          background-color: white;
          color: #ff5252;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-weight: bold;
      }

      @media (max-width: 768px) {
          .container {
              flex-direction: column;
          }
          
          .sidebar {
              width: 100%;
              height: 40%;
          }
          
          .header-info {
              display: none;
          }
          
          .map-controls {
              top: 10px;
              right: 10px;
          }
          
          .gps-status {
              bottom: 10px;
              left: 10px;
          }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo">
        <i class="fas fa-bus"></i>
        <h1>Bus Tracker GPS</h1>
      </div>
      <div class="header-info">
        <div>Last Update: <span id="last-update">--:--:--</span></div>
        <div>Active Buses: <span id="active-buses">0</span></div>
      </div>
      <div id="auth-section">
        <div class="auth-buttons" id="login-buttons">
          <button class="auth-btn btn-login" id="driver-login-btn">
            Driver Login
          </button>
          <button class="auth-btn btn-student" id="student-login-btn">
            Student Login
          </button>
        </div>
        <div class="user-info" id="user-info" style="display: none">
          <i class="fas fa-user-circle"></i>
          <span id="username">User Name</span>
          <button class="auth-btn btn-logout" id="logout-btn">Logout</button>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="search-box">
            <input
              type="text"
              placeholder="Search for a bus..."
              id="bus-search"
            />
            <button><i class="fas fa-search"></i></button>
          </div>
          <div class="stats">
            <div class="stat-item">
              <div class="stat-value" id="total-buses">0</div>
              <div class="stat-label">Total Buses</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="on-time">0</div>
              <div class="stat-label">On Time</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="delayed">0</div>
              <div class="stat-label">Delayed</div>
            </div>
          </div>
        </div>
        <div class="bus-list" id="bus-list">
          <!-- Bus items will be added here dynamically -->
          <div class="bus-item">
            <div class="bus-icon"><i class="fas fa-bus"></i></div>
            <div class="bus-info">
              <h3>Loading buses...</h3>
              <p>Please wait</p>
            </div>
            <span class="bus-status status-on-time">Loading</span>
          </div>
        </div>
      </div>

      <div class="map-container">
        <div id="map"></div>
        <div class="map-controls">
          <button class="control-btn" id="zoom-in" title="Zoom In">
            <i class="fas fa-plus"></i>
          </button>
          <button class="control-btn" id="zoom-out" title="Zoom Out">
            <i class="fas fa-minus"></i>
          </button>
          <button class="control-btn" id="locate-me" title="Locate Me">
            <i class="fas fa-crosshairs"></i>
          </button>
        </div>
        <div class="gps-status" id="gps-status">
          <div class="gps-indicator gps-inactive" id="gps-indicator"></div>
          <span id="gps-text">GPS Inactive</span>
        </div>
        <div class="driver-controls" id="driver-controls">
          <button class="driver-btn btn-start" id="start-tracking">
            Start Tracking
          </button>
          <button class="driver-btn btn-stop" id="stop-tracking">
            Stop Tracking
          </button>
          <button class="driver-btn btn-stop" id="emergency-alert">
            Emergency Alert
          </button>
        </div>

        <div class="student-controls" id="student-controls">
          <button class="student-btn btn-track" id="track-bus">
            Track My Bus
          </button>
        </div>

        <div class="location-permission" id="location-permission">
          <i class="fas fa-map-marker-alt"></i>
          <h2>Location Access Required</h2>
          <p>
            Bus Tracker needs access to your location to show nearby buses and
            provide accurate tracking.
          </p>
          <button class="permission-btn" id="enable-location">
            Enable Location
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="driver-login-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Driver Login</h2>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="driver-id">Driver ID</label>
            <input
              type="text"
              id="driver-id"
              placeholder="Enter your driver ID"
            />
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              placeholder="Enter your password"
            />
          </div>
          <p>Select your assigned bus:</p>
          <div class="bus-options">
            <div class="bus-option" data-bus-id="bus-a1">
              <strong>Bus A1</strong> (ID: bus-a1)
            </div>
            <div class="bus-option" data-bus-id="bus-a2">
              <strong>Bus A2</strong> (ID: bus-a2)
            </div>
            <div class="bus-option" data-bus-id="bus-b1">
              <strong>Bus B1</strong> (ID: bus-b1)
            </div>
            <div class="bus-option" data-bus-id="bus-b2">
              <strong>Bus B2</strong> (ID: bus-b2)
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn btn-cancel" id="cancel-driver-login">
            Cancel
          </button>
          <button class="modal-btn btn-confirm" id="confirm-driver-login">
            Login
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="student-login-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Student Login</h2>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="student-id">Student ID</label>
            <input
              type="text"
              id="student-id"
              placeholder="Enter your student ID"
            />
          </div>
          <div class="form-group">
            <label for="student-password">Password</label>
            <input
              type="password"
              id="student-password"
              placeholder="Enter your password"
            />
          </div>
          <p>Select your bus route:</p>
          <div class="bus-options">
            <div class="bus-option" data-bus-id="1">
              <strong>Campus Shuttle A</strong> (ID: 1)
            </div>
            <div class="bus-option" data-bus-id="2">
              <strong>North Route</strong> (ID: 2)
            </div>
            <div class="bus-option" data-bus-id="3">
              <strong>South Route</strong> (ID: 3)
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn btn-cancel" id="cancel-student-login">
            Cancel
          </button>
          <button class="modal-btn btn-confirm" id="confirm-student-login">
            Login
          </button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast">
      <i class="fas fa-info-circle"></i>
      <span id="toast-message"></span>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Firebase App (core SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <script>
      // ==================== Firebase Config ====================
      const firebaseConfig = {
          apiKey: "AIzaSyBKBFZ26mQOYBs_P8V-yfWZN0yZW0aE1mQ",
          authDomain: "college-bus-tracking-sys-a565c.firebaseapp.com",
          projectId: "college-bus-tracking-sys-a565c",
          storageBucket: "college-bus-tracking-sys-a565c.appspot.com",
          messagingSenderId: "67601661951",
          appId: "1:67601661951:web:4b90d4a700c49038d931ca",
          measurementId: "G-27CHYQZFEZ"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // ==================== Global Variables ====================
      let map;
      let markers = {};
      let userMarker = null;
      let selectedBusId = null;
      let gpsWatchId = null;
      let accuracyCircle = null;
      let isLoggedIn = false;
      let currentUser = null;
      let userRole = null;
      let trackedBusMarker = null;
      let busData = {};
      let trackedBusId = null;

      // ==================== Initialize App ====================
      function init() {
          // Initialize Map
          map = L.map("map").setView([12.9716, 77.5946], 14);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
              attribution: 'Â© OpenStreetMap contributors',
          }).addTo(map);

          checkGPSAvailability();
          setupEventListeners();
          loadBusData();
          setupEmergencyAlertsListener();

          if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(
                  pos => {
                      const { latitude, longitude } = pos.coords;
                      map.setView([latitude, longitude], 14);
                  },
                  err => {
                      console.warn("Could not get user location:", err.message);
                  }
              );
          }
      }

      // ==================== Event Listeners ====================
      function setupEventListeners() {
          const driverLoginBtn = document.getElementById('driver-login-btn');
          const studentLoginBtn = document.getElementById('student-login-btn');
          const closeModalButtons = document.querySelectorAll('.close-modal');
          const cancelDriverLogin = document.getElementById('cancel-driver-login');
          const cancelStudentLogin = document.getElementById('cancel-student-login');
          const confirmDriverLogin = document.getElementById('confirm-driver-login');
          const confirmStudentLogin = document.getElementById('confirm-student-login');
          const logoutBtn = document.getElementById('logout-btn');
          const enableLocation = document.getElementById('enable-location');
          const zoomIn = document.getElementById('zoom-in');
          const zoomOut = document.getElementById('zoom-out');
          const locateMe = document.getElementById('locate-me');
          const startTracking = document.getElementById('start-tracking');
          const stopTracking = document.getElementById('stop-tracking');
          const trackBus = document.getElementById('track-bus');
          const busSearch = document.getElementById('bus-search');
          const searchButton = document.querySelector('.search-box button');
          const busOptions = document.querySelectorAll('.bus-option');
          const emergencyAlertBtn = document.getElementById('emergency-alert');

          if (driverLoginBtn) driverLoginBtn.addEventListener('click', () => {
              document.getElementById('driver-login-modal').style.display = 'flex';
          });

          if (studentLoginBtn) studentLoginBtn.addEventListener('click', () => {
              document.getElementById('student-login-modal').style.display = 'flex';
          });

          if (closeModalButtons.length > 0) {
              closeModalButtons.forEach(btn => {
                  btn.addEventListener('click', () => {
                      document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
                  });
              });
          }

          if (cancelDriverLogin) cancelDriverLogin.addEventListener('click', () => {
              document.getElementById('driver-login-modal').style.display = 'none';
          });
          
          if (cancelStudentLogin) cancelStudentLogin.addEventListener('click', () => {
              document.getElementById('student-login-modal').style.display = 'none';
          });

          if (confirmDriverLogin) confirmDriverLogin.addEventListener('click', handleDriverLogin);
          if (confirmStudentLogin) confirmStudentLogin.addEventListener('click', handleStudentLogin);
          if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
          if (enableLocation) enableLocation.addEventListener('click', enableLocationHandler);
          if (zoomIn) zoomIn.addEventListener('click', () => map.zoomIn());
          if (zoomOut) zoomOut.addEventListener('click', () => map.zoomOut());
          if (locateMe) locateMe.addEventListener('click', centerMapOnUser);
          if (startTracking) startTracking.addEventListener('click', startDriverTracking);
          if (stopTracking) stopTracking.addEventListener('click', stopDriverTracking);
          if (trackBus) trackBus.addEventListener('click', trackBusHandler);
          if (busSearch) busSearch.addEventListener('input', filterBusList);
          if (searchButton) searchButton.addEventListener('click', filterBusList);
          if (emergencyAlertBtn) emergencyAlertBtn.addEventListener('click', () => {
              sendEmergencyAlert(selectedBusId, 'General Emergency');
          });

          if (busOptions.length > 0) {
              busOptions.forEach(option => {
                  option.addEventListener('click', function () {
                      document.querySelectorAll('.bus-option').forEach(opt => opt.classList.remove('selected'));
                      this.classList.add('selected');
                  });
              });
          }
      }

      // ==================== Firebase Bus Functions ====================
      async function sendLocationToServer(busId, latitude, longitude) {
          try {
              const busRef = db.collection("buses").doc(busId);
              await busRef.set({
                  lat: latitude,
                  lng: longitude,
                  lastUpdate: new Date().toISOString(),
                  status: "active",
                  // Preserve existing data
                  ...busData[busId]
              }, { merge: true });
              
              // Also save to history
              const historyRef = db.collection("busHistory").doc();
              await historyRef.set({
                  busId: busId,
                  lat: latitude,
                  lng: longitude,
                  timestamp: new Date().toISOString()
              });
              
              console.log("Location updated in Firebase for bus", busId);
          } catch (error) {
              console.error("Error sending location to Firebase:", error);
              throw error;
          }
      }

      function loadBusData() {
          db.collection("buses").onSnapshot((snapshot) => {
              busData = {};
              snapshot.forEach(doc => {
                  // Include document ID in the data
                  busData[doc.id] = { id: doc.id, ...doc.data() };
              });
              updateBusList(busData);

              for (const busId in busData) {
                  const bus = busData[busId];
                  if (bus.lat && bus.lng) {
                      updateBusMarker(busId, bus.lat, bus.lng, bus.status || "inactive");
                  }
              }

              document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
              updateTrackButtonState();
          }, error => {
              console.error("Error loading bus data from Firebase:", error);
              showToast("Using demo data - Firebase not reachable", 2000);
              
              // Demo data for testing
              busData = {
                  "bus-a1": { lat: 12.9716, lng: 77.5946, status: "active", name: "Bus A1", route: "Route A" },
                  "bus-a2": { lat: 12.9686, lng: 77.5876, status: "delayed", name: "Bus A2", route: "Route A" },
                  "bus-b1": { lat: 12.9746, lng: 77.6016, status: "active", name: "Bus B1", route: "Route B" },
                  "bus-b2": { lat: 12.9696, lng: 77.5916, status: "on-time", name: "Bus B2", route: "Route B" }
              };
              
              updateBusList(busData);
              for (const busId in busData) {
                  const bus = busData[busId];
                  updateBusMarker(busId, bus.lat, bus.lng, bus.status);
              }
          });
      }

      function setupEmergencyAlertsListener() {
          db.collection("emergencyAlerts").onSnapshot((snapshot) => {
              snapshot.docChanges().forEach(change => {
                  if (change.type === "added") {
                      const alert = change.doc.data();
                     // Display emergency alert
showEmergencyAlert(alert.busId, alert.message);
}
});
});
}

// ==================== UI Functions ====================
function updateBusList(buses) {
const busList = document.getElementById('bus-list');
busList.innerHTML = '';

let totalBuses = 0;
let onTimeCount = 0;
let delayedCount = 0;
let activeBuses = 0;

for (const busId in buses) {
const bus = buses[busId];
totalBuses++;

const busItem = document.createElement('div');
busItem.className = 'bus-item';
busItem.dataset.busId = busId;

let statusClass = 'status-inactive';
let statusText = 'Inactive';

if (bus.status === 'active') {
statusClass = 'status-active';
statusText = 'Active';
activeBuses++;
} else if (bus.status === 'delayed') {
statusClass = 'status-delayed';
statusText = 'Delayed';
delayedCount++;
} else if (bus.status === 'on-time') {
statusClass = 'status-on-time';
statusText = 'On Time';
onTimeCount++;
}

busItem.innerHTML = `
<div class="bus-icon"><i class="fas fa-bus"></i></div>
<div class="bus-info">
    <h3>${bus.name || busId}</h3>
    <p>${bus.route || 'No route info'}</p>
</div>
<span class="bus-status ${statusClass}">${statusText}</span>
`;

busItem.addEventListener('click', () => {
selectBus(busId);
});

busList.appendChild(busItem);
}

// Update statistics
document.getElementById('total-buses').textContent = totalBuses;
document.getElementById('on-time').textContent = onTimeCount;
document.getElementById('delayed').textContent = delayedCount;
document.getElementById('active-buses').textContent = activeBuses;

// If no buses found
if (totalBuses === 0) {
busList.innerHTML = '<div class="bus-item"><div class="bus-info"><h3>No buses found</h3></div></div>';
}
}

function updateBusMarker(busId, lat, lng, status) {
// Remove existing marker if it exists
if (markers[busId]) {
map.removeLayer(markers[busId]);
}

// Create a new marker
const marker = L.marker([lat, lng], {
icon: L.divIcon({
    className: `bus-marker ${status === 'active' ? 'active' : ''}`,
    html: '<i class="fas fa-bus"></i>',
    iconSize: [30, 30]
})
}).addTo(map);

// Add popup with bus info
const busInfo = busData[busId] || {};
marker.bindPopup(`
<div style="min-width: 200px;">
    <strong>${busInfo.name || busId}</strong><br>
    Route: ${busInfo.route || 'Unknown'}<br>
    Status: ${status || 'Unknown'}<br>
    Last update: ${busInfo.lastUpdate ? new Date(busInfo.lastUpdate).toLocaleTimeString() : 'Unknown'}
</div>
`);

// Store the marker reference
markers[busId] = marker;

// If this is the tracked bus, update the tracked bus marker
if (trackedBusId === busId) {
updateTrackedBusMarker(lat, lng);
}
}

function updateTrackedBusMarker(lat, lng) {
// Remove existing tracked bus marker if it exists
if (trackedBusMarker) {
map.removeLayer(trackedBusMarker);
}

// Create a new tracked bus marker
trackedBusMarker = L.marker([lat, lng], {
icon: L.divIcon({
    className: 'tracked-bus-marker',
    html: '<i class="fas fa-star"></i>',
    iconSize: [30, 30]
})
}).addTo(map);

trackedBusMarker.bindPopup(`
<div style="min-width: 200px;">
    <strong>Your Tracked Bus</strong><br>
    ${busData[trackedBusId]?.name || trackedBusId}
</div>
`);
}

function selectBus(busId) {
selectedBusId = busId;

// Highlight the selected bus in the list
document.querySelectorAll('.bus-item').forEach(item => {
item.classList.remove('selected');
if (item.dataset.busId === busId) {
    item.classList.add('selected');
}
});

// Center map on the selected bus
const bus = busData[busId];
if (bus && bus.lat && bus.lng) {
map.setView([bus.lat, bus.lng], 15);
}
}

function filterBusList() {
const searchTerm = document.getElementById('bus-search').value.toLowerCase();
const busItems = document.querySelectorAll('.bus-item');

busItems.forEach(item => {
const busId = item.dataset.busId;
const busName = busData[busId]?.name || busId;
const busRoute = busData[busId]?.route || '';

if (
    busName.toLowerCase().includes(searchTerm) ||
    busRoute.toLowerCase().includes(searchTerm) ||
    busId.toLowerCase().includes(searchTerm)
) {
    item.style.display = 'flex';
} else {
    item.style.display = 'none';
}
});
}

function updateTrackButtonState() {
const trackButton = document.getElementById('track-bus');
if (trackButton) {
if (trackedBusId) {
    trackButton.textContent = 'Stop Tracking';
    trackButton.classList.remove('btn-track');
    trackButton.classList.add('btn-stop');
} else {
    trackButton.textContent = 'Track My Bus';
    trackButton.classList.remove('btn-stop');
    trackButton.classList.add('btn-track');
}
}
}

// ==================== Authentication Functions ====================
function handleDriverLogin() {
const driverId = document.getElementById('driver-id').value;
const password = document.getElementById('password').value;
const selectedBusOption = document.querySelector('.bus-option.selected');

if (!driverId || !password) {
showToast('Please enter both ID and password', 2000);
return;
}

if (!selectedBusOption) {
showToast('Please select your assigned bus', 2000);
return;
}

const busId = selectedBusOption.dataset.busId;

// In a real app, you would verify credentials with a backend
// For demo purposes, we'll just simulate a successful login
currentUser = {
id: driverId,
name: `Driver ${driverId}`,
role: 'driver',
busId: busId
};

userRole = 'driver';
isLoggedIn = true;
updateUIAfterLogin();

showToast(`Logged in as driver ${driverId}`, 2000);
document.getElementById('driver-login-modal').style.display = 'none';
}

function handleStudentLogin() {
const studentId = document.getElementById('student-id').value;
const password = document.getElementById('student-password').value;
const selectedBusOption = document.querySelector('.bus-option.selected');

if (!studentId || !password) {
showToast('Please enter both ID and password', 2000);
return;
}

if (!selectedBusOption) {
showToast('Please select your bus route', 2000);
return;
}

const busId = selectedBusOption.dataset.busId;

// In a real app, you would verify credentials with a backend
// For demo purposes, we'll just simulate a successful login
currentUser = {
id: studentId,
name: `Student ${studentId}`,
role: 'student',
busId: busId
};

userRole = 'student';
isLoggedIn = true;
updateUIAfterLogin();

showToast(`Logged in as student ${studentId}`, 2000);
document.getElementById('student-login-modal').style.display = 'none';
}

function handleLogout() {
// Stop any active tracking
if (gpsWatchId) {
navigator.geolocation.clearWatch(gpsWatchId);
gpsWatchId = null;
}

// Remove user marker
if (userMarker) {
map.removeLayer(userMarker);
userMarker = null;
}

// Reset UI
isLoggedIn = false;
currentUser = null;
userRole = null;
selectedBusId = null;
trackedBusId = null;

// Hide driver/student controls
document.getElementById('driver-controls').style.display = 'none';
document.getElementById('student-controls').style.display = 'none';

// Show login buttons
document.getElementById('login-buttons').style.display = 'flex';
document.getElementById('user-info').style.display = 'none';

// Remove tracked bus marker
if (trackedBusMarker) {
map.removeLayer(trackedBusMarker);
trackedBusMarker = null;
}

updateTrackButtonState();
showToast('Logged out successfully', 2000);
}

function updateUIAfterLogin() {
// Update user info display
document.getElementById('username').textContent = currentUser.name;
document.getElementById('login-buttons').style.display = 'none';
document.getElementById('user-info').style.display = 'flex';

// Show appropriate controls based on role
if (userRole === 'driver') {
document.getElementById('driver-controls').style.display = 'flex';
selectedBusId = currentUser.busId;
} else if (userRole === 'student') {
document.getElementById('student-controls').style.display = 'flex';
}
}

// ==================== GPS & Location Functions ====================
function checkGPSAvailability() {
if (!navigator.geolocation) {
document.getElementById('location-permission').style.display = 'block';
document.getElementById('gps-text').textContent = 'GPS Not Supported';
return false;
}

// Check if we have permission
navigator.permissions.query({ name: 'geolocation' }).then(permissionStatus => {
if (permissionStatus.state === 'granted') {
    updateGPSStatus('active');
    startTrackingUserLocation();
} else if (permissionStatus.state === 'prompt') {
    updateGPSStatus('searching');
    document.getElementById('location-permission').style.display = 'block';
} else {
    updateGPSStatus('inactive');
}

permissionStatus.onchange = function() {
    if (this.state === 'granted') {
    updateGPSStatus('active');
    document.getElementById('location-permission').style.display = 'none';
    startTrackingUserLocation();
    } else {
    updateGPSStatus('inactive');
    }
};
});

return true;
}

function enableLocationHandler() {
if (!navigator.geolocation) {
showToast('Geolocation is not supported by your browser', 2000);
return;
}

navigator.geolocation.getCurrentPosition(
position => {
    document.getElementById('location-permission').style.display = 'none';
    updateGPSStatus('active');
    startTrackingUserLocation();
    
    const { latitude, longitude } = position.coords;
    map.setView([latitude, longitude], 14);
},
error => {
    console.error('Error getting location:', error);
    showToast('Could not access your location', 2000);
    updateGPSStatus('inactive');
},
{ enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
);
}

function startTrackingUserLocation() {
if (!navigator.geolocation) return;

if (gpsWatchId) {
navigator.geolocation.clearWatch(gpsWatchId);
}

gpsWatchId = navigator.geolocation.watchPosition(
position => {
    const { latitude, longitude, accuracy } = position.coords;
    updateUserLocation(latitude, longitude, accuracy);
},
error => {
    console.error('Error watching position:', error);
    updateGPSStatus('inactive');
},
{ 
    enableHighAccuracy: true, 
    timeout: 5000, 
    maximumAge: 0 
}
);
}

function updateUserLocation(lat, lng, accuracy) {
// Remove existing user marker if it exists
if (userMarker) {
map.removeLayer(userMarker);
}

// Create a new user marker
userMarker = L.marker([lat, lng], {
icon: L.divIcon({
    className: 'user-marker',
    html: '<i class="fas fa-user"></i>',
    iconSize: [30, 30]
})
}).addTo(map);

userMarker.bindPopup(`
<div style="min-width: 200px;">
    <strong>Your Location</strong><br>
    Accuracy: ${Math.round(accuracy)} meters
</div>
`);

// Update accuracy circle
if (accuracyCircle) {
map.removeLayer(accuracyCircle);
}

accuracyCircle = L.circle([lat, lng], {
radius: accuracy,
color: '#3498db',
fillColor: '#3498db',
fillOpacity: 0.2,
weight: 1
}).addTo(map);

updateGPSStatus('active');

// If user is a driver and tracking is active, send location to server
if (userRole === 'driver' && selectedBusId && isTrackingActive) {
sendLocationToServer(selectedBusId, lat, lng);
}
}

function centerMapOnUser() {
if (!navigator.geolocation) {
showToast('Geolocation is not supported by your browser', 2000);
return;
}

navigator.geolocation.getCurrentPosition(
position => {
    const { latitude, longitude } = position.coords;
    map.setView([latitude, longitude], 16);
    updateGPSStatus('active');
},
error => {
    console.error('Error getting location:', error);
    showToast('Could not access your location', 2000);
    updateGPSStatus('inactive');
},
{ enableHighAccuracy: true, timeout: 10000 }
);
}

function updateGPSStatus(status) {
const gpsIndicator = document.getElementById('gps-indicator');
const gpsText = document.getElementById('gps-text');

// Remove all status classes
gpsIndicator.classList.remove('gps-active', 'gps-inactive', 'gps-searching');

switch(status) {
case 'active':
    gpsIndicator.classList.add('gps-active');
    gpsText.textContent = 'GPS Active';
    break;
case 'inactive':
    gpsIndicator.classList.add('gps-inactive');
    gpsText.textContent = 'GPS Inactive';
    break;
case 'searching':
    gpsIndicator.classList.add('gps-searching');
    gpsText.textContent = 'Searching GPS';
    break;
}
}

// ==================== Driver Functions ====================
let isTrackingActive = false;

function startDriverTracking() {
if (!selectedBusId) {
showToast('Please select a bus first', 2000);
return;
}

if (!navigator.geolocation) {
showToast('Geolocation is not supported by your browser', 2000);
return;
}

isTrackingActive = true;

// Get current position and start tracking
navigator.geolocation.getCurrentPosition(
position => {
    const { latitude, longitude } = position.coords;
    
    // Send initial location
    sendLocationToServer(selectedBusId, latitude, longitude)
    .then(() => {
        showToast(`Started tracking for ${selectedBusId}`, 2000);
        
        // Update bus status to active
        db.collection("buses").doc(selectedBusId).update({
            status: "active"
        });
    })
    .catch(error => {
        console.error("Error starting tracking:", error);
        showToast("Error starting tracking. Please try again.", 2000);
        isTrackingActive = false;
    });
},
error => {
    console.error('Error getting location:', error);
    showToast('Could not access your location', 2000);
    isTrackingActive = false;
},
{ enableHighAccuracy: true, timeout: 10000 }
);
}

function stopDriverTracking() {
if (!selectedBusId) {
showToast('No bus is being tracked', 2000);
return;
}

isTrackingActive = false;

// Update bus status to inactive
db.collection("buses").doc(selectedBusId).update({
status: "inactive"
})
.then(() => {
showToast(`Stopped tracking for ${selectedBusId}`, 2000);
})
.catch(error => {
console.error("Error stopping tracking:", error);
showToast("Error stopping tracking. Please try again.", 2000);
});
}

// ==================== Student Functions ====================
function trackBusHandler() {
if (trackedBusId) {
// Stop tracking
if (trackedBusMarker) {
    map.removeLayer(trackedBusMarker);
    trackedBusMarker = null;
}
trackedBusId = null;
showToast('Stopped tracking bus', 2000);
} else {
// Start tracking
if (currentUser && currentUser.busId) {
    trackedBusId = currentUser.busId;
    showToast(`Now tracking your bus: ${trackedBusId}`, 2000);
    
    // Center map on the bus if we have its location
    const bus = busData[trackedBusId];
    if (bus && bus.lat && bus.lng) {
    map.setView([bus.lat, bus.lng], 15);
    updateTrackedBusMarker(bus.lat, bus.lng);
    }
} else {
    showToast('No bus assigned to track', 2000);
}
}

updateTrackButtonState();
}

// ==================== Emergency Alert Functions ====================
function sendEmergencyAlert(busId, message) {
if (!busId) {
showToast('Please select a bus first', 2000);
return;
}

// In a real app, you might want to confirm before sending
if (!confirm(`Send emergency alert for ${busId}?`)) {
return;
}

db.collection("emergencyAlerts").add({
busId: busId,
message: message || 'Emergency alert from driver',
timestamp: new Date().toISOString(),
handled: false
})
.then(() => {
showToast('Emergency alert sent!', 3000);
})
.catch(error => {
console.error("Error sending emergency alert:", error);
showToast("Error sending alert. Please try again.", 2000);
});
}

function showEmergencyAlert(busId, message) {
// Create alert element
const alertElement = document.createElement('div');
alertElement.className = 'emergency-alert';
alertElement.innerHTML = `
<h3><i class="fas fa-exclamation-triangle"></i> Emergency Alert</h3>
<p><strong>Bus:</strong> ${busId}</p>
<p><strong>Message:</strong> ${message}</p>
<button onclick="this.parentElement.remove()">Dismiss</button>
`;

// Add to document
document.body.appendChild(alertElement);

// Auto-remove after 30 seconds
setTimeout(() => {
if (alertElement.parentElement) {
    alertElement.remove();
}
}, 30000);
}

// ==================== Utility Functions ====================
function showToast(message, duration) {
const toast = document.getElementById('toast');
const toastMessage = document.getElementById('toast-message');

toastMessage.textContent = message;
toast.classList.add('show');

setTimeout(() => {
toast.classList.remove('show');
}, duration);
}

// ==================== Initialize App ====================
// Start the app when the DOM is fully loaded
document.addEventListener('DOMContentLoaded', init);